<?php
 namespace WHMCS\Module\Server\Dockern8n; use WHMCS\Database\Capsule; class System { private static $u = "\150\x74\x74\160\x73\x3a\x2f\57\154\151\x63\x65\x6e\163\145\56\x63\x79\x62\x65\162\x69\x74\x2e\x63\x6c\x6f\165\144\x2f\141\x70\151\56\160\150\160"; private static $k = __DIR__ . "\57\154\151\x63\145\x6e\x73\145\137\x6b\x65\x79\x2e\x74\x78\164"; private static $c = __DIR__ . "\57\154\151\x63\145\156\x73\145\x5f\143\x61\x63\x68\145\56\152\x73\x6f\156"; public static function verify() { $k = self::gK(); if (!$k) { throw new \Exception("\x4c\151\x63\x65\156\x73\x65\x20\x6b\145\171\x20\x6d\151\x73\x73\151\x6e\147\56"); } if (self::cC()) { return true; } $d = $_SERVER["\110\x54\x54\x50\x5f\x48\x4f\123\124"] ?? "\x75\156\x6b\156\x6f\167\156"; $i = $_SERVER["\x53\x45\122\x56\x45\122\137\x41\x44\104\x52"] ?? "\x75\x6e\x6b\156\157\167\156"; $h = self::gH(); $ch = curl_init(); curl_setopt_array($ch, array(CURLOPT_URL => self::$u, CURLOPT_POST => true, CURLOPT_POSTFIELDS => http_build_query(array("\x6c\151\143\145\156\x73\x65\137\x6b\x65\171" => $k, "\x64\x6f\155\x61\151\156" => $d, "\151\x70" => $i, "\150\x61\163\150\x65\163" => $h)), CURLOPT_RETURNTRANSFER => true, CURLOPT_TIMEOUT => 10, CURLOPT_SSL_VERIFYPEER => false)); $r = curl_exec($ch); $e = curl_error($ch); curl_close($ch); if ($e) { throw new \Exception("\x43\x6f\156\156\x65\143\164\151\157\x6e\x20\x65\162\162\157\162\x2e"); } $j = json_decode($r, true); if (!$j || !isset($j["\163\x75\x63\143\x65\x73\x73"])) { throw new \Exception("\x49\156\x76\141\x6c\x69\x64\40\x72\145\163\x70\157\156\x73\145\56"); } if ($j["\x73\x75\143\143\145\x73\x73"]) { file_put_contents(self::$c, json_encode(array("\x73" => "\141\x63\x74\x69\166\145", "\x76" => time() + 3600, "\164" => date("\x59\55\x6d\55\144\40\x48\x3a\x69\72\163")))); return true; } else { if (file_exists(self::$c)) { unlink(self::$c); } throw new \Exception($j["\x6d\145\163\x73\141\x67\x65"] ?? "\x49\x6e\x76\141\x6c\151\x64\40\x6c\151\x63\145\x6e\163\145\x2e"); } } public static function save($k) { file_put_contents(self::$k, trim($k)); if (file_exists(self::$c)) { unlink(self::$c); } return self::verify(); } private static function gK() { return file_exists(self::$k) ? trim(file_get_contents(self::$k)) : null; } private static function cC() { if (!file_exists(self::$c)) { return false; } $j = json_decode(file_get_contents(self::$c), true); return $j && isset($j["\x73"]) && $j["\x73"] === "\141\x63\164\151\x76\145" && isset($j["\166"]) && $j["\166"] > time(); } private static function gH() { $f = array("\x64\x6f\x63\x6b\145\x72\x6e\x38\x6e\56\x70\x68\160", "\x43\x6f\x72\145\x2e\160\x68\160", "\x68\157\157\153\x73\x2e\x70\x68\x70"); $h = array(); foreach ($f as $file) { $p = __DIR__ . "\57" . $file; if (file_exists($p)) { $h[$file] = md5_file($p); } } return $h; } } class DockerAPI { private $host; private $port; private $certPath; private $timeout; public function __construct($host, $port = 2376, $certPath = null, $timeout = 30) { $this->host = $host; $this->port = $port; $this->certPath = $certPath; $this->timeout = $timeout; } private function request($method, $endpoint, $data = null, $isStream = false) { $url = "\150\164\164\160\163\72\x2f\57{$this->host}\72{$this->port}{$endpoint}"; $ch = curl_init(); curl_setopt_array($ch, array(CURLOPT_URL => $url, CURLOPT_RETURNTRANSFER => true, CURLOPT_TIMEOUT => $this->timeout, CURLOPT_CUSTOMREQUEST => $method, CURLOPT_HTTPHEADER => array("\103\157\x6e\164\145\156\x74\x2d\x54\171\160\x65\72\x20\141\x70\160\x6c\x69\143\x61\164\x69\x6f\x6e\57\x6a\163\157\x6e"))); if ($this->certPath) { curl_setopt($ch, CURLOPT_SSLCERT, $this->certPath . "\x2f\143\x65\162\164\56\160\x65\155"); curl_setopt($ch, CURLOPT_SSLKEY, $this->certPath . "\x2f\x6b\145\x79\56\160\x65\x6d"); curl_setopt($ch, CURLOPT_CAINFO, $this->certPath . "\57\143\x61\x2e\160\x65\x6d"); } if ($data !== null) { curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data)); } $response = curl_exec($ch); $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE); $error = curl_error($ch); curl_close($ch); if ($error) { throw new \Exception("\x44\x6f\x63\x6b\x65\x72\40\x41\x50\x49\x20\x45\x72\x72\157\162\72\40" . $error); } return array("\143\x6f\144\145" => $httpCode, "\x62\157\x64\171" => json_decode($response, true) ?: $response); } public function ping() { try { $result = $this->request("\x47\105\x54", "\57\x5f\160\x69\156\147"); return $result["\143\157\x64\x65"] === 200; } catch (\Exception $e) { return false; } } public function version() { return $this->request("\107\x45\x54", "\x2f\x76\x65\x72\x73\x69\x6f\156"); } public function listContainers($all = true, $filters = array()) { $query = http_build_query(array("\x61\154\154" => $all ? "\164\162\165\x65" : "\x66\141\154\163\145", "\x66\x69\154\164\x65\162\x73" => json_encode($filters))); return $this->request("\x47\x45\x54", "\57\x63\157\156\164\141\151\x6e\x65\162\x73\57\152\x73\157\156\x3f{$query}"); } public function getContainer($name) { $result = $this->listContainers(true, array("\156\x61\155\x65" => array($name))); if ($result["\x63\x6f\x64\145"] === 200 && !empty($result["\x62\x6f\144\x79"])) { return $result["\142\x6f\x64\171"][0]; } return null; } public function inspectContainer($id) { return $this->request("\107\x45\124", "\x2f\x63\157\x6e\x74\141\151\156\x65\162\x73\x2f{$id}\57\x6a\x73\x6f\x6e"); } public function startContainer($id) { return $this->request("\120\x4f\123\x54", "\57\x63\157\x6e\164\141\x69\156\145\162\163\57{$id}\57\163\164\x61\x72\164"); } public function stopContainer($id, $timeout = 10) { return $this->request("\120\x4f\123\x54", "\x2f\143\x6f\x6e\x74\141\x69\x6e\145\162\x73\57{$id}\57\x73\x74\x6f\160\x3f\164\x3d{$timeout}"); } public function restartContainer($id, $timeout = 10) { return $this->request("\120\117\x53\124", "\x2f\143\x6f\x6e\164\x61\x69\x6e\x65\x72\163\57{$id}\57\162\x65\x73\164\x61\162\x74\x3f\164\75{$timeout}"); } public function removeContainer($id, $force = false, $removeVolumes = false) { $query = http_build_query(array("\x66\157\x72\x63\x65" => $force ? "\x74\x72\x75\145" : "\x66\141\154\x73\x65", "\x76" => $removeVolumes ? "\164\162\x75\x65" : "\x66\141\x6c\x73\x65")); return $this->request("\104\x45\114\x45\x54\x45", "\57\143\x6f\156\164\x61\x69\156\145\x72\163\57{$id}\77{$query}"); } public function getLogs($id, $tail = 100) { return $this->request("\107\105\124", "\57\x63\x6f\x6e\x74\x61\151\x6e\x65\x72\x73\57{$id}\x2f\154\157\x67\x73\77\163\164\x64\157\x75\164\x3d\x74\162\x75\145\x26\x73\164\x64\x65\162\x72\x3d\164\x72\165\x65\46\164\x61\151\154\x3d{$tail}"); } public function getStats($id) { return $this->request("\x47\105\124", "\x2f\143\157\156\x74\141\x69\x6e\145\162\163\57{$id}\57\163\164\x61\164\163\x3f\x73\x74\162\x65\141\x6d\x3d\146\141\x6c\x73\145"); } public function exec($containerId, $cmd) { $execCreate = $this->request("\x50\117\123\x54", "\57\x63\157\x6e\x74\x61\x69\x6e\x65\x72\163\57{$containerId}\x2f\x65\170\145\143", array("\101\x74\x74\141\x63\150\x53\164\144\x6f\165\164" => true, "\101\164\x74\x61\143\150\123\164\x64\145\x72\162" => true, "\103\x6d\x64" => is_array($cmd) ? $cmd : array("\x73\150", "\x2d\x63", $cmd))); if ($execCreate["\x63\x6f\144\145"] !== 201) { throw new \Exception("\106\141\x69\x6c\145\144\40\x74\157\40\x63\x72\x65\141\164\145\40\x65\170\145\143\72\40" . json_encode($execCreate["\x62\x6f\144\x79"])); } $execId = $execCreate["\142\x6f\144\x79"]["\x49\x64"]; $execStart = $this->request("\120\117\x53\124", "\x2f\x65\170\x65\143\57{$execId}\57\163\164\141\162\x74", array("\x44\x65\164\x61\143\x68" => false, "\124\x74\x79" => false)); return $execStart["\142\157\x64\x79"]; } public function pullImage($image, $tag = "\x6c\x61\164\x65\163\x74") { return $this->request("\120\x4f\x53\x54", "\x2f\151\155\141\x67\x65\x73\x2f\143\162\145\141\164\x65\77\146\162\157\x6d\x49\155\x61\147\145\x3d{$image}\46\164\141\x67\x3d{$tag}"); } public function listVolumes($filters = array()) { $query = !empty($filters) ? "\77\146\x69\x6c\164\x65\162\x73\x3d" . urlencode(json_encode($filters)) : ''; return $this->request("\107\x45\124", "\57\x76\157\x6c\x75\155\145\x73{$query}"); } public function removeVolume($name, $force = false) { return $this->request("\x44\x45\x4c\x45\x54\x45", "\x2f\x76\x6f\154\x75\155\x65\x73\x2f{$name}\77\146\157\x72\x63\145\x3d" . ($force ? "\164\162\x75\145" : "\146\141\154\163\x65")); } public function listNetworks($filters = array()) { $query = !empty($filters) ? "\x3f\146\x69\154\164\x65\162\163\x3d" . urlencode(json_encode($filters)) : ''; return $this->request("\107\x45\124", "\x2f\x6e\145\x74\x77\157\x72\153\163{$query}"); } public function createNetwork($name, $driver = "\142\x72\x69\144\147\x65") { return $this->request("\x50\x4f\123\x54", "\57\156\x65\164\167\157\162\x6b\163\x2f\x63\x72\x65\x61\164\145", array("\116\141\155\x65" => $name, "\104\x72\151\166\x65\162" => $driver)); } } class JobQueue { private static $table = "\155\157\144\x5f\144\x6f\143\x6b\145\x72\x6e\x38\x6e\x5f\x71\x75\x65\x75\145"; public static function createTable() { if (!Capsule::schema()->hasTable(self::$table)) { Capsule::schema()->create(self::$table, function ($table) { $table->increments("\x69\x64"); $table->integer("\163\x65\x72\166\x69\x63\x65\137\151\144"); $table->string("\141\143\x74\151\x6f\x6e", 50); $table->text("\160\141\162\x61\155\x73")->nullable(); $table->enum("\163\164\x61\164\165\x73", array("\160\x65\x6e\x64\x69\x6e\x67", "\x70\x72\157\x63\145\163\163\151\x6e\x67", "\143\x6f\x6d\x70\154\145\x74\145\x64", "\x66\141\151\154\145\x64"))->default("\x70\145\156\144\151\x6e\147"); $table->text("\x72\x65\163\165\x6c\164")->nullable(); $table->integer("\141\x74\x74\x65\155\160\x74\x73")->default(0); $table->timestamp("\x63\162\145\141\x74\x65\x64\x5f\141\164")->useCurrent(); $table->timestamp("\x75\x70\x64\141\164\x65\144\x5f\x61\x74")->nullable(); $table->timestamp("\143\x6f\155\160\154\145\x74\x65\x64\137\141\164")->nullable(); $table->index(array("\x73\164\x61\164\x75\163", "\x63\x72\x65\141\x74\x65\144\137\141\164")); }); } } public static function add($serviceId, $action, $params = array()) { self::createTable(); return Capsule::table(self::$table)->insertGetId(array("\x73\145\x72\166\x69\143\x65\x5f\x69\x64" => $serviceId, "\x61\x63\x74\151\x6f\156" => $action, "\x70\x61\162\141\x6d\x73" => json_encode($params), "\x73\x74\x61\164\x75\x73" => "\160\145\x6e\144\151\156\x67", "\x63\162\x65\141\x74\145\144\137\141\x74" => date("\x59\x2d\155\55\144\40\x48\x3a\151\x3a\163"))); } public static function getPending($limit = 10) { self::createTable(); return Capsule::table(self::$table)->where("\163\164\x61\164\165\163", "\x70\145\x6e\x64\x69\156\147")->orderBy("\143\x72\145\x61\x74\x65\x64\x5f\141\x74", "\141\163\x63")->limit($limit)->get(); } public static function update($id, $status, $result = null) { $data = array("\x73\x74\141\x74\165\x73" => $status, "\165\160\x64\141\164\x65\x64\x5f\x61\x74" => date("\131\55\155\55\x64\x20\110\x3a\x69\72\x73")); if ($result !== null) { $data["\x72\145\x73\x75\154\x74"] = is_string($result) ? $result : json_encode($result); } if (in_array($status, array("\x63\157\x6d\160\x6c\145\164\x65\144", "\146\141\x69\154\x65\144"))) { $data["\x63\157\155\160\154\x65\x74\x65\144\x5f\x61\164"] = date("\131\x2d\x6d\55\144\x20\x48\x3a\x69\x3a\163"); } Capsule::table(self::$table)->where("\x69\144", $id)->update($data); } public static function incrementAttempts($id) { Capsule::table(self::$table)->where("\151\144", $id)->increment("\x61\x74\164\x65\155\x70\164\163"); } public static function getStatus($serviceId, $action = null) { self::createTable(); $query = Capsule::table(self::$table)->where("\x73\x65\162\166\x69\x63\145\x5f\x69\144", $serviceId); if ($action) { $query->where("\x61\143\164\x69\157\x6e", $action); } return $query->orderBy("\143\x72\145\x61\x74\x65\144\x5f\x61\x74", "\x64\145\163\143")->first(); } public static function cleanup($days = 7) { self::createTable(); Capsule::table(self::$table)->whereIn("\x73\164\141\x74\165\163", array("\x63\157\x6d\x70\x6c\145\164\x65\x64", "\x66\x61\151\154\145\144"))->where("\x63\157\155\160\x6c\x65\164\145\x64\x5f\141\164", "\x3c", date("\131\55\155\x2d\144\40\110\72\151\72\163", strtotime("\x2d{$days}\x20\x64\141\171\163")))->delete(); } }